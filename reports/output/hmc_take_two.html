<!DOCTYPE html>
<HTML lang = "en">
<HEAD>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>HMC &amp; DSGE - Take 2</title>
  

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      TeX: { equationNumbers: { autoNumber: "AMS" } }
    });
  </script>

  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

  
<style>
pre.hljl {
    border: 1px solid #ccc;
    margin: 5px;
    padding: 5px;
    overflow-x: auto;
    color: rgb(68,68,68); background-color: rgb(251,251,251); }
pre.hljl > span.hljl-t { }
pre.hljl > span.hljl-w { }
pre.hljl > span.hljl-e { }
pre.hljl > span.hljl-eB { }
pre.hljl > span.hljl-o { }
pre.hljl > span.hljl-k { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kc { color: rgb(59,151,46); font-style: italic; }
pre.hljl > span.hljl-kd { color: rgb(214,102,97); font-style: italic; }
pre.hljl > span.hljl-kn { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kp { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kr { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kt { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-n { }
pre.hljl > span.hljl-na { }
pre.hljl > span.hljl-nb { }
pre.hljl > span.hljl-nbp { }
pre.hljl > span.hljl-nc { }
pre.hljl > span.hljl-ncB { }
pre.hljl > span.hljl-nd { color: rgb(214,102,97); }
pre.hljl > span.hljl-ne { }
pre.hljl > span.hljl-neB { }
pre.hljl > span.hljl-nf { color: rgb(66,102,213); }
pre.hljl > span.hljl-nfm { color: rgb(66,102,213); }
pre.hljl > span.hljl-np { }
pre.hljl > span.hljl-nl { }
pre.hljl > span.hljl-nn { }
pre.hljl > span.hljl-no { }
pre.hljl > span.hljl-nt { }
pre.hljl > span.hljl-nv { }
pre.hljl > span.hljl-nvc { }
pre.hljl > span.hljl-nvg { }
pre.hljl > span.hljl-nvi { }
pre.hljl > span.hljl-nvm { }
pre.hljl > span.hljl-l { }
pre.hljl > span.hljl-ld { color: rgb(148,91,176); font-style: italic; }
pre.hljl > span.hljl-s { color: rgb(201,61,57); }
pre.hljl > span.hljl-sa { color: rgb(201,61,57); }
pre.hljl > span.hljl-sb { color: rgb(201,61,57); }
pre.hljl > span.hljl-sc { color: rgb(201,61,57); }
pre.hljl > span.hljl-sd { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdB { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdC { color: rgb(201,61,57); }
pre.hljl > span.hljl-se { color: rgb(59,151,46); }
pre.hljl > span.hljl-sh { color: rgb(201,61,57); }
pre.hljl > span.hljl-si { }
pre.hljl > span.hljl-so { color: rgb(201,61,57); }
pre.hljl > span.hljl-sr { color: rgb(201,61,57); }
pre.hljl > span.hljl-ss { color: rgb(201,61,57); }
pre.hljl > span.hljl-ssB { color: rgb(201,61,57); }
pre.hljl > span.hljl-nB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nbB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nfB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nh { color: rgb(59,151,46); }
pre.hljl > span.hljl-ni { color: rgb(59,151,46); }
pre.hljl > span.hljl-nil { color: rgb(59,151,46); }
pre.hljl > span.hljl-noB { color: rgb(59,151,46); }
pre.hljl > span.hljl-oB { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-ow { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-p { }
pre.hljl > span.hljl-c { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-ch { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cm { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cp { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cpB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cs { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-csB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-g { }
pre.hljl > span.hljl-gd { }
pre.hljl > span.hljl-ge { }
pre.hljl > span.hljl-geB { }
pre.hljl > span.hljl-gh { }
pre.hljl > span.hljl-gi { }
pre.hljl > span.hljl-go { }
pre.hljl > span.hljl-gp { }
pre.hljl > span.hljl-gs { }
pre.hljl > span.hljl-gsB { }
pre.hljl > span.hljl-gt { }
</style>



  <style type="text/css">
  @font-face {
  font-style: normal;
  font-weight: 300;
}
@font-face {
  font-style: normal;
  font-weight: 400;
}
@font-face {
  font-style: normal;
  font-weight: 600;
}
html {
  font-family: sans-serif; /* 1 */
  -ms-text-size-adjust: 100%; /* 2 */
  -webkit-text-size-adjust: 100%; /* 2 */
}
body {
  margin: 0;
}
article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
menu,
nav,
section,
summary {
  display: block;
}
audio,
canvas,
progress,
video {
  display: inline-block; /* 1 */
  vertical-align: baseline; /* 2 */
}
audio:not([controls]) {
  display: none;
  height: 0;
}
[hidden],
template {
  display: none;
}
a:active,
a:hover {
  outline: 0;
}
abbr[title] {
  border-bottom: 1px dotted;
}
b,
strong {
  font-weight: bold;
}
dfn {
  font-style: italic;
}
h1 {
  font-size: 2em;
  margin: 0.67em 0;
}
mark {
  background: #ff0;
  color: #000;
}
small {
  font-size: 80%;
}
sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
sup {
  top: -0.5em;
}
sub {
  bottom: -0.25em;
}
img {
  border: 0;
}
svg:not(:root) {
  overflow: hidden;
}
figure {
  margin: 1em 40px;
}
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}
pre {
  overflow: auto;
}
code,
kbd,
pre,
samp {
  font-family: monospace, monospace;
  font-size: 1em;
}
button,
input,
optgroup,
select,
textarea {
  color: inherit; /* 1 */
  font: inherit; /* 2 */
  margin: 0; /* 3 */
}
button {
  overflow: visible;
}
button,
select {
  text-transform: none;
}
button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
  -webkit-appearance: button; /* 2 */
  cursor: pointer; /* 3 */
}
button[disabled],
html input[disabled] {
  cursor: default;
}
button::-moz-focus-inner,
input::-moz-focus-inner {
  border: 0;
  padding: 0;
}
input {
  line-height: normal;
}
input[type="checkbox"],
input[type="radio"] {
  box-sizing: border-box; /* 1 */
  padding: 0; /* 2 */
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  height: auto;
}
input[type="search"] {
  -webkit-appearance: textfield; /* 1 */
  -moz-box-sizing: content-box;
  -webkit-box-sizing: content-box; /* 2 */
  box-sizing: content-box;
}
input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}
fieldset {
  border: 1px solid #c0c0c0;
  margin: 0 2px;
  padding: 0.35em 0.625em 0.75em;
}
legend {
  border: 0; /* 1 */
  padding: 0; /* 2 */
}
textarea {
  overflow: auto;
}
optgroup {
  font-weight: bold;
}
table {
  font-family: monospace, monospace;
  font-size : 0.8em;
  border-collapse: collapse;
  border-spacing: 0;
}
td,
th {
  padding: 0;
}
thead th {
    border-bottom: 1px solid black;
    background-color: white;
}
tr:nth-child(odd){
  background-color: rgb(248,248,248);
}


/*
* Skeleton V2.0.4
* Copyright 2014, Dave Gamache
* www.getskeleton.com
* Free to use under the MIT license.
* http://www.opensource.org/licenses/mit-license.php
* 12/29/2014
*/
.container {
  position: relative;
  width: 100%;
  max-width: 960px;
  margin: 0 auto;
  padding: 0 20px;
  box-sizing: border-box; }
.column,
.columns {
  width: 100%;
  float: left;
  box-sizing: border-box; }
@media (min-width: 400px) {
  .container {
    width: 85%;
    padding: 0; }
}
@media (min-width: 550px) {
  .container {
    width: 80%; }
  .column,
  .columns {
    margin-left: 4%; }
  .column:first-child,
  .columns:first-child {
    margin-left: 0; }

  .one.column,
  .one.columns                    { width: 4.66666666667%; }
  .two.columns                    { width: 13.3333333333%; }
  .three.columns                  { width: 22%;            }
  .four.columns                   { width: 30.6666666667%; }
  .five.columns                   { width: 39.3333333333%; }
  .six.columns                    { width: 48%;            }
  .seven.columns                  { width: 56.6666666667%; }
  .eight.columns                  { width: 65.3333333333%; }
  .nine.columns                   { width: 74.0%;          }
  .ten.columns                    { width: 82.6666666667%; }
  .eleven.columns                 { width: 91.3333333333%; }
  .twelve.columns                 { width: 100%; margin-left: 0; }

  .one-third.column               { width: 30.6666666667%; }
  .two-thirds.column              { width: 65.3333333333%; }

  .one-half.column                { width: 48%; }

  /* Offsets */
  .offset-by-one.column,
  .offset-by-one.columns          { margin-left: 8.66666666667%; }
  .offset-by-two.column,
  .offset-by-two.columns          { margin-left: 17.3333333333%; }
  .offset-by-three.column,
  .offset-by-three.columns        { margin-left: 26%;            }
  .offset-by-four.column,
  .offset-by-four.columns         { margin-left: 34.6666666667%; }
  .offset-by-five.column,
  .offset-by-five.columns         { margin-left: 43.3333333333%; }
  .offset-by-six.column,
  .offset-by-six.columns          { margin-left: 52%;            }
  .offset-by-seven.column,
  .offset-by-seven.columns        { margin-left: 60.6666666667%; }
  .offset-by-eight.column,
  .offset-by-eight.columns        { margin-left: 69.3333333333%; }
  .offset-by-nine.column,
  .offset-by-nine.columns         { margin-left: 78.0%;          }
  .offset-by-ten.column,
  .offset-by-ten.columns          { margin-left: 86.6666666667%; }
  .offset-by-eleven.column,
  .offset-by-eleven.columns       { margin-left: 95.3333333333%; }

  .offset-by-one-third.column,
  .offset-by-one-third.columns    { margin-left: 34.6666666667%; }
  .offset-by-two-thirds.column,
  .offset-by-two-thirds.columns   { margin-left: 69.3333333333%; }

  .offset-by-one-half.column,
  .offset-by-one-half.columns     { margin-left: 52%; }

}
html {
  font-size: 62.5%; }
body {
  font-size: 1.5em; /* currently ems cause chrome bug misinterpreting rems on body element */
  line-height: 1.6;
  font-weight: 400;
  font-family: "Raleway", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
  color: #222; }
h1, h2, h3, h4, h5, h6 {
  margin-top: 0;
  margin-bottom: 2rem;
  font-weight: 300; }
h1 { font-size: 3.6rem; line-height: 1.2;  letter-spacing: -.1rem;}
h2 { font-size: 3.4rem; line-height: 1.25; letter-spacing: -.1rem; }
h3 { font-size: 3.2rem; line-height: 1.3;  letter-spacing: -.1rem; }
h4 { font-size: 2.8rem; line-height: 1.35; letter-spacing: -.08rem; }
h5 { font-size: 2.4rem; line-height: 1.5;  letter-spacing: -.05rem; }
h6 { font-size: 1.5rem; line-height: 1.6;  letter-spacing: 0; }

p {
  margin-top: 0; }
a {
  color: #1EAEDB; }
a:hover {
  color: #0FA0CE; }
.button,
button,
input[type="submit"],
input[type="reset"],
input[type="button"] {
  display: inline-block;
  height: 38px;
  padding: 0 30px;
  color: #555;
  text-align: center;
  font-size: 11px;
  font-weight: 600;
  line-height: 38px;
  letter-spacing: .1rem;
  text-transform: uppercase;
  text-decoration: none;
  white-space: nowrap;
  background-color: transparent;
  border-radius: 4px;
  border: 1px solid #bbb;
  cursor: pointer;
  box-sizing: border-box; }
.button:hover,
button:hover,
input[type="submit"]:hover,
input[type="reset"]:hover,
input[type="button"]:hover,
.button:focus,
button:focus,
input[type="submit"]:focus,
input[type="reset"]:focus,
input[type="button"]:focus {
  color: #333;
  border-color: #888;
  outline: 0; }
.button.button-primary,
button.button-primary,
input[type="submit"].button-primary,
input[type="reset"].button-primary,
input[type="button"].button-primary {
  color: #FFF;
  background-color: #33C3F0;
  border-color: #33C3F0; }
.button.button-primary:hover,
button.button-primary:hover,
input[type="submit"].button-primary:hover,
input[type="reset"].button-primary:hover,
input[type="button"].button-primary:hover,
.button.button-primary:focus,
button.button-primary:focus,
input[type="submit"].button-primary:focus,
input[type="reset"].button-primary:focus,
input[type="button"].button-primary:focus {
  color: #FFF;
  background-color: #1EAEDB;
  border-color: #1EAEDB; }
input[type="email"],
input[type="number"],
input[type="search"],
input[type="text"],
input[type="tel"],
input[type="url"],
input[type="password"],
textarea,
select {
  height: 38px;
  padding: 6px 10px; /* The 6px vertically centers text on FF, ignored by Webkit */
  background-color: #fff;
  border: 1px solid #D1D1D1;
  border-radius: 4px;
  box-shadow: none;
  box-sizing: border-box; }
/* Removes awkward default styles on some inputs for iOS */
input[type="email"],
input[type="number"],
input[type="search"],
input[type="text"],
input[type="tel"],
input[type="url"],
input[type="password"],
textarea {
  -webkit-appearance: none;
     -moz-appearance: none;
          appearance: none; }
textarea {
  min-height: 65px;
  padding-top: 6px;
  padding-bottom: 6px; }
input[type="email"]:focus,
input[type="number"]:focus,
input[type="search"]:focus,
input[type="text"]:focus,
input[type="tel"]:focus,
input[type="url"]:focus,
input[type="password"]:focus,
textarea:focus,
select:focus {
  border: 1px solid #33C3F0;
  outline: 0; }
label,
legend {
  display: block;
  margin-bottom: .5rem;
  font-weight: 600; }
fieldset {
  padding: 0;
  border-width: 0; }
input[type="checkbox"],
input[type="radio"] {
  display: inline; }
label > .label-body {
  display: inline-block;
  margin-left: .5rem;
  font-weight: normal; }
ul {
  list-style: circle; }
ol {
  list-style: decimal; }
ul ul,
ul ol,
ol ol,
ol ul {
  margin: 1.5rem 0 1.5rem 3rem;
  font-size: 90%; }
li > p {margin : 0;}
th,
td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #E1E1E1; }
th:first-child,
td:first-child {
  padding-left: 0; }
th:last-child,
td:last-child {
  padding-right: 0; }
button,
.button {
  margin-bottom: 1rem; }
input,
textarea,
select,
fieldset {
  margin-bottom: 1.5rem; }
pre,
blockquote,
dl,
figure,
table,
p,
ul,
ol,
form {
  margin-bottom: 1.0rem; }
.u-full-width {
  width: 100%;
  box-sizing: border-box; }
.u-max-full-width {
  max-width: 100%;
  box-sizing: border-box; }
.u-pull-right {
  float: right; }
.u-pull-left {
  float: left; }
hr {
  margin-top: 3rem;
  margin-bottom: 3.5rem;
  border-width: 0;
  border-top: 1px solid #E1E1E1; }
.container:after,
.row:after,
.u-cf {
  content: "";
  display: table;
  clear: both; }

pre {
  display: block;
  padding: 9.5px;
  margin: 0 0 10px;
  font-size: 13px;
  line-height: 1.42857143;
  word-break: break-all;
  word-wrap: break-word;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre.hljl {
  margin: 0 0 10px;
  display: block;
  background: #f5f5f5;
  border-radius: 4px;
  padding : 5px;
}

pre.output {
  background: #ffffff;
}

pre.code {
  background: #ffffff;
}

pre.julia-error {
  color : red
}

code,
kbd,
pre,
samp {
  font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
  font-size: 0.9em;
}


@media (min-width: 400px) {}
@media (min-width: 550px) {}
@media (min-width: 750px) {}
@media (min-width: 1000px) {}
@media (min-width: 1200px) {}

h1.title {margin-top : 20px}
img {max-width : 100%}
div.title {text-align: center;}

  </style>
</HEAD>

<BODY>
  <div class ="container">
    <div class = "row">
      <div class = "col-md-12 twelve columns">
        <div class="title">
          <h1 class="title">HMC &amp; DSGE - Take 2</h1>
          <h5>Gilberto Boaretto & Daniel Coutinho</h5>
          <h5>September, 2020</h5>
        </div>

        <p>Almost all derivates are now implemented analytically. There are two files for it: <code>diffs_estrut.jl</code>, for the derivates of the DSGE model, following Iskrev &#40;2010&#41; and <code>diff_kalman.jl</code>, that take the derivate with respect to the Kalman Filter equations. I will review them bellow.</p>
<p>There is the need to make the parameters all belong to the whole real line and so we reparametrize them. This was done using a Julia package, but to be able to handle the analytical derivates they are now done by hand &#40;without the package&#41;. I review those in the third section.</p>
<p>We need to derivate the posterior and priors. This is review in the fourth section.</p>
<h1>Analytical derivates</h1>
<h2>DSGE model</h2>
<p>We follow Iskrev &#40;2010&#41;. We will write a macro model in structural form with <span class="math">$z_t$</span> being a <span class="math">$m$</span> dimensional vector of endogenous variables:</p>
<p class="math">\[
\Gamma_0(\theta)z_t = \Gamma_1(\theta) E_t(z_{t+1}) + \Gamma_2(\theta) z_{t-1} + \Gamma_3 (\theta) u_t
\]</p>
<p>And the reduced form is:</p>
<p class="math">\[
z_t = A(\tau)z_{t-1} + B(\tau) u_t
\]</p>
<p>Let <span class="math">$x_t$</span> be the observed variables, which is <span class="math">$l$</span> dimensional, so the measurement equation is <span class="math">$x_t = C(\theta) z_t$</span>. Usually, <span class="math">$C(\theta)$</span> is just a matrix of 1 and 0.</p>
<p>We also establish that <span class="math">$\Omega = B^{\prime}B$</span>, <span class="math">$\Sigma_z = A\Sigma_zA^{\prime} + \Omega$</span> and <span class="math">$Ex_{t+i}x_t = \Sigma_x(i)$</span>, which is:</p>
<p class="math">\[
\Sigma_x(i) = \begin{cases}
C\Sigma_zC^{\prime} \quad \text{if } i = 0\\
CA^{i}\Sigma_zC^{\prime} \quad \text{otherwise}
\end{cases}
\]</p>
<p>And define the vector <span class="math">$\sigma_T = \left[vech(\Sigma_x(0))^{\prime}\ vech(\Sigma_x(1))^{\prime}\ ...\ vech(\Sigma_x(T-1))^{\prime}\right]$</span> and <span class="math">$\tau = \left[vec(A)^{\prime} \ vec(C)^{\prime} \ vech(\Omega)^{\prime}\right]$</span>. To obtain the effects of the structural form in the reduced form we will use the chain rule:</p>
<p class="math">\[
J(\tau) = \underbrace{\dfrac{\partial \sigma_T}{\partial \tau}}_{J_1} \underbrace{\dfrac{\partial \tau}{\partial \theta}}_{J_2}
\]</p>
<p>To start take the reduced form:</p>
<p class="math">\[
z_t = A(\tau)z_{t-1} + B(\tau) u_t
\]</p>
<p>Put everything forward one period:</p>
<p class="math">\[
z_{t+1} = A(\tau)z_{t} + B(\tau) u_{t+1}
\]</p>
<p>So taking the expectation, we have:</p>
<p class="math">\[
E_t(z_{t+1}) = A(\tau)z_{t}
\]</p>
<p>So plug this on the structural form:</p>
<p class="math">\[
\Gamma_0(\theta)z_t = \Gamma_1(\theta) A(\tau)z_t + \Gamma_2(\theta) z_{t-1} + \Gamma_3 (\theta) u_t \\
(\Gamma_0(\theta)- \Gamma_1(\theta) A(\tau))z_t = \Gamma_2(\theta) z_{t-1} + \Gamma_3 (\theta) u_t
\]</p>
<p>Lets start with <span class="math">$J_1 = \dfrac{\partial \sigma_T}{\partial \tau} = \dfrac{\partial}{\partial \tau} \left[vech(\Sigma_x(0))^{\prime}\ vech(\Sigma_x(1))^{\prime}\ ...\ vech(\Sigma_x(T-1))^{\prime}\right]$</span> and recall that:</p>
<p class="math">\[
\Sigma_x(i) = \begin{cases}
C\Sigma_zC^{\prime} \quad \text{if } i = 0\\
CA^{i}\Sigma_zC^{\prime} \quad \text{otherwise}
\end{cases}
\]</p>
<p>So we can take the derivate of each block.</p>
<h3><span class="math">$J_2$</span></h3>
<p>Previously we found that:</p>
<p class="math">\[
(\Gamma_0(\theta)- \Gamma_1(\theta) A(\theta))z_t = \Gamma_2(\theta) z_{t-1} + \Gamma_3 (\theta) u_t
\]</p>
<p>And we had the reduced form:</p>
<p class="math">\[
z_t = A(\tau)z_{t-1} + B(\tau)u_t
\]</p>
<p>Plug it on the <span class="math">$z_t$</span> above and we will have:</p>
<p class="math">\[
[\Gamma_0(\theta)- \Gamma_1(\theta) A(\tau)][A(\theta)z_{t-1} + B(\theta)u_t] = \Gamma_2(\theta) z_{t-1} + \Gamma_3 (\theta) u_t
\]</p>
<p>Rearranging:</p>
<p class="math">\[
[(\Gamma_0(\theta) - \Gamma_1(\theta)A(\tau))A(\tau) - \Gamma_2(\theta)]z_{t-1} + [(\Gamma_0(\theta)-\Gamma_1(\theta)A(\tau))B(\tau) - \Gamma_3(\theta)]u_t
\]</p>
<p>So we must have:</p>
<p class="math">\[
\begin{cases}
[\Gamma_0(\theta) - \Gamma_1(\theta)A(\tau)]A(\tau) - \Gamma_2(\theta) = 0 := F_1\\
[\Gamma_0(\theta)-\Gamma_1(\theta)A(\tau)]\Omega(\tau)[\Gamma_0(\theta)-\Gamma_1(\theta)A(\tau)]^{\prime} - \Gamma_3(\theta)\Gamma_3(\theta)^{\prime} = 0 := F_2
\end{cases}
\]</p>
<p>So we can use the implicit function theorem on <span class="math">$f = [F_1^{\prime} \; F_2^{\prime}]^{\prime}$</span> to get:</p>
<p class="math">\[
\frac{\partial \theta}{\partial \tau} = \left(\frac{\partial f}{\partial \theta}\right)^{-1}\dfrac{\partial f}{\partial \tau}
\]</p>
<p>So we will need <span class="math">$\frac{\partial F_1}{\partial \theta}$</span>, <span class="math">$\frac{\partial F_2}{\partial \theta}$</span>, <span class="math">$\frac{\partial F_1}{\partial \tau}$</span>,<span class="math">$\frac{\partial F_2}{\partial \tau}$</span>. Notice that <span class="math">$F_2$</span> is symmetric and we can use <span class="math">$vech$</span></p>
<h4><span class="math">$\dfrac{\partial F_1}{\partial \tau}$</span></h4>
<p class="math">\[
\dfrac{\partial F_1}{\partial \tau} = -\Gamma_1 (dA) A - (\Gamma_0 - \Gamma_1 A)dA \therefore \\
dvec(F_1) = - (A^{\prime} \otimes \Gamma_1) dvec(A) - (I_m \otimes (\Gamma_0 - \Gamma_1 A)) dvec(A) = \\
dvec(F_1) = (-A^{\prime} \otimes \Gamma_1 - I_m \otimes \Gamma_0 + I_m \otimes \Gamma_1A)dvec(A)
\]</p>
<p>We will use <code>l</code> as the number of observable variables and <code>n</code> is the number of shocks. Here is the code:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>dF1_tau</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_0</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-n'>l</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-cs'># l is the number of observables</span><span class='hljl-t'>
    </span><span class='hljl-cs'># n is the number of shocks</span><span class='hljl-t'>
    </span><span class='hljl-n'>m</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_0</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>nn</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Int</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-oB'>+</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-ni'>2</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>dvecA</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-oB'>^</span><span class='hljl-ni'>2</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-nf'>zeros</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-oB'>^</span><span class='hljl-ni'>2</span><span class='hljl-p'>,</span><span class='hljl-n'>m</span><span class='hljl-oB'>*</span><span class='hljl-n'>l</span><span class='hljl-oB'>+</span><span class='hljl-n'>nn</span><span class='hljl-p'>)]</span><span class='hljl-t'>
    </span><span class='hljl-p'>(</span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-oB'>-</span><span class='hljl-n'>A</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_1</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_0</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>),</span><span class='hljl-n'>Gamma_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>A</span><span class='hljl-p'>))</span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>dvecA</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
dF1_tau &#40;generic function with 1 method&#41;
</pre>


<h4><span class="math">$\dfrac{\partial F_1}{\partial \theta}$</span></h4>
<p class="math">\[
\dfrac{\partial F_1}{\partial \theta} = [d\Gamma_0 - d\Gamma_1A]A - d\Gamma_2 = d\Gamma_0 A - d\Gamma_1A^2 - d\Gamma_2 \therefore\\
dvec(F_1) = (A^\prime \otimes I_m)dvec(\Gamma_0) - (A^{\prime2} \otimes I_m) dvec(\Gamma_1) - dvec(\Gamma_2)
\]</p>
<p>The function that does that:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>dF1_theta</span><span class='hljl-p'>(</span><span class='hljl-n'>dGamma_0</span><span class='hljl-p'>,</span><span class='hljl-n'>dGamma_1</span><span class='hljl-p'>,</span><span class='hljl-n'>dGamma_2</span><span class='hljl-p'>,</span><span class='hljl-n'>A</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>m</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-cs'>#dv_size = size(dGamma_0,1)*size(dGamma_0,2)</span><span class='hljl-t'>
    </span><span class='hljl-cs'>#dGamma_0 = vecc(dGamma_0)</span><span class='hljl-t'>
    </span><span class='hljl-cs'>#dGamma_1 = vecc(dGamma_1,dv_size,1)</span><span class='hljl-t'>
    </span><span class='hljl-cs'>#dGamma_2 = vecc(dGamma_2)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>A</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>,</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>))</span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_0</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>A</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>A</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>,</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>))</span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_1</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_2</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
dF1_theta &#40;generic function with 1 method&#41;
</pre>


<h4><span class="math">$\dfrac{\partial F_2}{\partial \tau}$</span></h4>
<p>Recall that <span class="math">$F_2$</span> is:</p>
<p class="math">\[
F_2 := [\Gamma_0(\theta)-\Gamma_1(\theta)A(\tau)]\Omega(\tau)[\Gamma_0(\theta)-\Gamma_1(\theta)A(\tau)]^{\prime} - \Gamma_3(\theta)\Gamma_3(\theta)^{\prime} = 0
\]</p>
<p>So:</p>
<p class="math">\[
\frac{\partial F_2}{\partial \tau} = -\Gamma_1(dA) \Omega [\Gamma_0 - \Gamma_1 A]^{\prime} - [\Gamma_0 - \Gamma_1 A] \Omega (dA^{\prime}) \Gamma_1^{\prime} + [\Gamma_0 - \Gamma_1 A]d\Omega [\Gamma_0 - \Gamma_1 A]^{\prime}
\]</p>
<p>Passing vec on everything:</p>
<p class="math">\[
dvec(F_2) = -[(\Gamma_0 - \Gamma_1A)\Omega \otimes \Gamma_1] dvec(A) - (\Gamma_1 \otimes [\Gamma_0 - \Gamma_1 A]\Omega)dvec(A^\prime) + ([\Gamma_0 - \Gamma_1 A] \otimes [\Gamma_0 - \Gamma_1 A]) dvec(\Omega)
\]</p>
<p>Now <span class="math">$vech$</span> stuff:</p>
<p class="math">\[
D_mdvech(F_2) = -[(\Gamma_0 - \Gamma_1A)\Omega \otimes \Gamma_1] dvec(A) - [\Gamma_1 \otimes (\Gamma_0 - \Gamma_1 A)\Omega]dvec(A^\prime) + [(\Gamma_0 - \Gamma_1 A) \otimes (\Gamma_0 - \Gamma_1 A)] D_mdvec(\Omega) = \\
-[(\Gamma_0 - \Gamma_1A)\Omega \otimes \Gamma_1 - (\Gamma_1 \otimes (\Gamma_0 - \Gamma_1 A)\Omega)K_{mm}]dvec(A) + [(\Gamma_0 - \Gamma_1 A) \otimes (\Gamma_0 - \Gamma_1 A)] D_mdvec(\Omega)
\]</p>
<p>Notice that the code is implemented using a vech:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>dF2_tau</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_0</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Omega</span><span class='hljl-p'>,</span><span class='hljl-n'>l</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>m</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_0</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>b_aux</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_0</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>A</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Omega</span><span class='hljl-t'>
    </span><span class='hljl-n'>Dm</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>duplication_matrix</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>Kmm</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>commutation_matrix</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>,</span><span class='hljl-n'>m</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>nn</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Int</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-oB'>+</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-ni'>2</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-n'>dvecA</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-oB'>^</span><span class='hljl-ni'>2</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-nf'>zeros</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-oB'>^</span><span class='hljl-ni'>2</span><span class='hljl-p'>,</span><span class='hljl-n'>m</span><span class='hljl-oB'>*</span><span class='hljl-n'>l</span><span class='hljl-oB'>+</span><span class='hljl-n'>nn</span><span class='hljl-p'>)]</span><span class='hljl-t'>
    </span><span class='hljl-n'>dvecOmega</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>zeros</span><span class='hljl-p'>(</span><span class='hljl-n'>nn</span><span class='hljl-p'>,</span><span class='hljl-n'>m</span><span class='hljl-oB'>^</span><span class='hljl-ni'>2</span><span class='hljl-oB'>+</span><span class='hljl-n'>m</span><span class='hljl-oB'>*</span><span class='hljl-n'>l</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>nn</span><span class='hljl-p'>)]</span><span class='hljl-t'>
    </span><span class='hljl-n'>res</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-p'>(</span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>b_aux</span><span class='hljl-p'>,</span><span class='hljl-n'>Gamma_1</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>b_aux</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Kmm</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>dvecA</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_0</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-n'>Gamma_0</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>A</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Dm</span><span class='hljl-oB'>*</span><span class='hljl-n'>dvecOmega</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-p'>(</span><span class='hljl-nf'>pinv</span><span class='hljl-p'>(</span><span class='hljl-n'>Dm</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>res</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
dF2_tau &#40;generic function with 1 method&#41;
</pre>


<h4><span class="math">$\dfrac{\partial F_2}{\partial \theta}$</span></h4>
<p>Using the definition of <span class="math">$F_2$</span> above, we have:</p>
<p class="math">\[
\frac{\partial F_2}{\partial \theta} = d\Gamma_0 \Omega (\Gamma_0 - \Gamma_1A)^{\prime} - d\Gamma_1A\Omega(\Gamma_0 - \Gamma_1 A)^{\prime} + (\Gamma_0 - \Gamma_1 A) \Omega d\Gamma_0^{\prime} - (\Gamma_0 - \Gamma_1 A)\Omega (d\Gamma_1 A)^{\prime} - d\Gamma_3 \Gamma_3 - \Gamma_3 (d\Gamma_3)^{\prime}
\]</p>
<p>Now <span class="math">$vec$</span> everything:</p>
<p class="math">\[
\frac{\partial vec(F_2)}{\partial \theta} = ((\Gamma_0 - \Gamma_1A)\Omega \otimes I_m)dvec(\Gamma_0)  - ((\Gamma_0 - \Gamma_1 A)\Omega{}A^{\prime} \otimes I_m)dvec(\Gamma_1) + (I_m \otimes (\Gamma_0 - \Gamma_1 A) \Omega) dvec(\Gamma_0^{\prime}) - (I_m \otimes (\Gamma_0 - \Gamma_1 A)\Omega) dvec(\Gamma_1^{\prime}) - (\Gamma_3 \otimes I_m) dvec(\Gamma_3)  - (I_m \otimes \Gamma_3) dvec(\Gamma_3^{\prime})
\]</p>
<p>Use the commutation matrix to group the terms that depend on the derivate of the transpose:</p>
<p class="math">\[
\frac{\partial vec(F_2)}{\partial \theta} = ((\Gamma_0 - \Gamma_1A)\Omega \otimes I_m)dvec(\Gamma_0)  - ((\Gamma_0 - \Gamma_1 A)\Omega{}A^{\prime} \otimes I_m)dvec(\Gamma_1) + (I_m \otimes (\Gamma_0 - \Gamma_1 A) \Omega)K_{mn} dvec(\Gamma_0) - (I_m \otimes (\Gamma_0 - \Gamma_1 A)\Omega) K_{mm} dvec(\Gamma_1) - (\Gamma_3 \otimes I_m) dvec(\Gamma_3)  - (I_m \otimes \Gamma_3) K_{mm}dvec(\Gamma_3) \\
= [(\Gamma_0 - \Gamma_1A)\Omega \otimes I_m + (I_m \otimes (\Gamma_0 - \Gamma_1 A) \Omega{}) K_{mn}]dvec(\Gamma_0)  - [(\Gamma_0 - \Gamma_1 A)\Omega{}A^{\prime} \otimes I_m + (I_m \otimes (\Gamma_0 - \Gamma_1 A)\Omega) K_{mm}]dvec(\Gamma_1)   - [\Gamma_3 \otimes I_m + (I_m \otimes \Gamma_3) K_{mm}]dvec(\Gamma_3)
\]</p>
<p>Use <span class="math">$vech$</span> where you can and the duplication matrix:</p>
<p class="math">\[
D_m\frac{\partial vech(F_2)}{\partial \theta} = [(\Gamma_0 - \Gamma_1A)\Omega \otimes I_m + (I_m \otimes (\Gamma_0 - \Gamma_1 A) \Omega{}) K_{mn}]dvec(\Gamma_0)  - [(\Gamma_0 - \Gamma_1 A)\Omega{}A^{\prime} \otimes I_m + (I_m \otimes (\Gamma_0 - \Gamma_1 A)\Omega) K_{mm}]dvec(\Gamma_1)   - [\Gamma_3 \otimes I_m + (I_m \otimes \Gamma_3) K_{mn}]dvec(\Gamma_3)
\]</p>
<p>And the function in Julia:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>dF2_theta</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_0</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_3</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_0</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_3</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Omega</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>A</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>m</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_0</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>b_aux</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_0</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>A</span><span class='hljl-t'>
    </span><span class='hljl-n'>Dm</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>duplication_matrix</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>Kmm</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>commutation_matrix</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>,</span><span class='hljl-n'>m</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-n'>dv_size</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>dGamma_0</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>dGamma_0</span><span class='hljl-p'>,</span><span class='hljl-ni'>2</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-cs'>#dGamma_0 = vecc(dGamma_0)</span><span class='hljl-t'>
    </span><span class='hljl-cs'>#dGamma_1 = vecc(dGamma_1)</span><span class='hljl-t'>
    </span><span class='hljl-cs'>#dGamma_2 = vecc(dGamma_2)</span><span class='hljl-t'>

    </span><span class='hljl-n'>b1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>b_aux</span><span class='hljl-oB'>*</span><span class='hljl-n'>Omega</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>b_aux</span><span class='hljl-oB'>*</span><span class='hljl-n'>Omega</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Kmm</span><span class='hljl-t'>
    </span><span class='hljl-n'>b2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>b_aux</span><span class='hljl-oB'>*</span><span class='hljl-n'>Omega</span><span class='hljl-oB'>*</span><span class='hljl-n'>A</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>,</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>),</span><span class='hljl-n'>b_aux</span><span class='hljl-oB'>*</span><span class='hljl-n'>Omega</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Kmm</span><span class='hljl-t'>
    </span><span class='hljl-n'>b3</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_3</span><span class='hljl-p'>,</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>),</span><span class='hljl-n'>Gamma_3</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Kmm</span><span class='hljl-t'>
    </span><span class='hljl-n'>res</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>b1</span><span class='hljl-oB'>*</span><span class='hljl-n'>dGamma_0</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>b2</span><span class='hljl-oB'>*</span><span class='hljl-n'>dGamma_1</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>b3</span><span class='hljl-oB'>*</span><span class='hljl-n'>dGamma_3</span><span class='hljl-t'>
    </span><span class='hljl-n'>res</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>pinv</span><span class='hljl-p'>(</span><span class='hljl-n'>Dm</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>res</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
dF2_theta &#40;generic function with 1 method&#41;
</pre>


<p>The following function join all the pieces:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>dtheta</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_0</span><span class='hljl-p'>,</span><span class='hljl-n'>Gamma_1</span><span class='hljl-p'>,</span><span class='hljl-n'>Gamma_2</span><span class='hljl-p'>,</span><span class='hljl-n'>Gamma_3</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_0</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_3</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Omega</span><span class='hljl-p'>,</span><span class='hljl-n'>l</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>Df_theta</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>dF1_theta</span><span class='hljl-p'>(</span><span class='hljl-n'>dGamma_0</span><span class='hljl-p'>,</span><span class='hljl-n'>dGamma_1</span><span class='hljl-p'>,</span><span class='hljl-n'>dGamma_2</span><span class='hljl-p'>,</span><span class='hljl-n'>A</span><span class='hljl-p'>);</span><span class='hljl-nf'>dF2_theta</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_0</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_3</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_0</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dGamma_3</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Omega</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>A</span><span class='hljl-p'>)]</span><span class='hljl-t'>
    </span><span class='hljl-n'>Df_tau</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>dF1_tau</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_0</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-n'>l</span><span class='hljl-p'>);</span><span class='hljl-t'> </span><span class='hljl-nf'>dF2_tau</span><span class='hljl-p'>(</span><span class='hljl-n'>Gamma_0</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Gamma_2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Omega</span><span class='hljl-p'>,</span><span class='hljl-n'>l</span><span class='hljl-p'>)]</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>pinv</span><span class='hljl-p'>(</span><span class='hljl-n'>Df_tau</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Df_theta</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
dtheta &#40;generic function with 1 method&#41;
</pre>


<h4>Derivates of reduced form matrices</h4>
<p>We have that:</p>
<p class="math">\[
\frac{dvec(A)}{d \tau} = [I_{m^2},\mathbf{0}_{lm \times lm}, \mathbf{0}_{n^2(n+1)^2/4,n^2(n+1)^2/4}]\\
\frac{dvec(C)}{d\tau} = [\mathbf{0}_{m^2 \times m^2}, I_{lm},  \mathbf{0}_{n^2(n+1)^2/4,n^2(n+1)^2/4}] \\
\frac{dvec(\Omega)}{d\tau} = [\mathbf{0}_{m^2 \times m^2},\mathbf{0}_{lm \times lm}, I_{n^2(n+1)^2/4}] \\
\]</p>
<h2>Kalman Filter</h2>
<p>I followed a somewhat obscure book called <em>Estimation of Dynamic Econometric Models with Errors in Variables</em> &#40;by Jaime Terceiro Lomba&#41; that has the derivates of the State Space Model. Fernandez-Villaverde paper suggests a paper by Mark Watson on that. We will use the state space model:</p>
<p class="math">\[
y_t = Gx_t + v_t, \quad v_t \sim N(0,R)\\
x_{t+1} = Ax_t + w_{t+1} \quad v_t \sim N(0,Q)
\]</p>
<p>Let the state have dimension <span class="math">$n$</span> and the observable variable <span class="math">$m$</span>. We will define and use the following:</p>
<p class="math">\[
\tilde{y}_t = y_t - Gx_t \quad \quad (2.1)\\
x_{t+1} = Ax_t + K_t \tilde{y}_t \quad \quad (2.2)\\
K_t = (AP_{t|t-1}G^{\prime})B_t^{-1} \quad \quad (2.3)\\
P_{t+1|t} = AP_{t|t-1}A^{\prime} + Q - K_tB_tK_t^{\prime}\quad \quad (2.4)\\
B_t = GP_{t|t-1}G^{\prime} + R \quad \quad (2.5)\\
\]</p>
<p>In which <span class="math">$K_t$</span> is the Kalman gain.</p>
<p>Starting with 2.1:</p>
<p class="math">\[
\frac{\partial \tilde{y}_t}{\partial \theta} = -dGx_t - G\frac{\partial x_t}{\partial \theta} \quad (i)
\]</p>
<p>Now pass vec on everything:</p>
<p class="math">\[
\frac{\partial \tilde{y}_t}{\partial \theta} = (x_t' \otimes I_m) dvec(G) - G \frac{\partial x_t}{\partial \theta}
\]</p>
<p>The code that does that:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>grad_y</span><span class='hljl-p'>(</span><span class='hljl-n'>x_hat_l</span><span class='hljl-p'>,</span><span class='hljl-n'>grad_x_hat_l</span><span class='hljl-p'>,</span><span class='hljl-n'>G</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dG</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>m</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>G</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>transpose</span><span class='hljl-p'>(</span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>x_hat_l</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>))</span><span class='hljl-oB'>*</span><span class='hljl-n'>dG</span><span class='hljl-oB'>&#39;-</span><span class='hljl-n'>G</span><span class='hljl-oB'>*</span><span class='hljl-n'>grad_x_hat_l</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
grad_y &#40;generic function with 1 method&#41;
</pre>


<p>Now 2.2:</p>
<p class="math">\[
\frac{\partial x_{t+1}}{\partial \theta} = dA x_t + A \frac{\partial x_t}{\partial \theta} + dK_t \tilde{y}_t + K_t d\tilde{y}_t \quad(ii)
\]</p>
<p>Vec stuff:</p>
<p class="math">\[
\frac{\partial x_{t+1}}{\partial \theta} = (x_t^{\prime} \otimes I_n) dvec(A) + A \frac{\partial x_t}{\partial \theta} + (\tilde{y}_t \otimes I_n) dvec(K_t) + K_t \frac{\partial \tilde{y}_t}{\partial \theta}
\]</p>
<p>And the code:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>grad_x_hat</span><span class='hljl-p'>(</span><span class='hljl-n'>x_hat_l</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dA</span><span class='hljl-p'>,</span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-n'>grad_x_hat_l</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>grad_y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>K</span><span class='hljl-p'>,</span><span class='hljl-n'>dK</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>transpose</span><span class='hljl-p'>(</span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>x_hat_l</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>,</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>n</span><span class='hljl-p'>))</span><span class='hljl-oB'>*</span><span class='hljl-n'>dA</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>A</span><span class='hljl-oB'>*</span><span class='hljl-n'>grad_x_hat_l</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>,</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>n</span><span class='hljl-p'>))</span><span class='hljl-oB'>*</span><span class='hljl-n'>dK</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>K</span><span class='hljl-oB'>*</span><span class='hljl-n'>grad_y</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
grad_x_hat &#40;generic function with 1 method&#41;
</pre>


<p>We will need the derivate of <span class="math">$K_t$</span>, which is expression 2.3:</p>
<p class="math">\[
dK_t = (dAP_{t|t-1}G^{\prime} + AdP_{t|t-1}G^{\prime})B_t^{-1} + (AP_{t|t-1}G^{\prime})dB_t^{-1}
\]</p>
<p>Now using the fact that <span class="math">$dB_t^{-1} = - B_t^{-1}dB_t B_t^{-1}$</span>, we have:</p>
<p class="math">\[
dK_t = (dAP_{t|t-1}G^{\prime} + AdP_{t|t-1}G^{\prime})B_t^{-1} -(AP_{t|t-1}G^{\prime})B_t^{-1}dB_tB_t^{-1}
\]</p>
<p>Passing vec on everything, we have:</p>
<p class="math">\[
dvec(K_t) = ((P_{t|t-1}G^{\prime}B_t^{-1}) \otimes I_n) dvec(A) + (B_t^{-1}G \otimes A) dvec(P_{t|t-1}) + (B_t^{-1} \otimes AP_{t|t-1}G^{\prime}B_t^{-1}) dvec(B_t)
\]</p>
<p>And the function that does that:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>diff_K</span><span class='hljl-p'>(</span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-n'>P</span><span class='hljl-p'>,</span><span class='hljl-n'>G</span><span class='hljl-p'>,</span><span class='hljl-n'>S_l</span><span class='hljl-p'>,</span><span class='hljl-n'>dA</span><span class='hljl-p'>,</span><span class='hljl-n'>dG</span><span class='hljl-p'>,</span><span class='hljl-n'>dP</span><span class='hljl-p'>,</span><span class='hljl-n'>dS_l</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>m</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>G</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>P_inv</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>P</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>Kmn</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>commutation_matrix</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>,</span><span class='hljl-n'>n</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>transpose</span><span class='hljl-p'>(</span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>P_inv</span><span class='hljl-oB'>*</span><span class='hljl-n'>G</span><span class='hljl-oB'>*</span><span class='hljl-n'>S_l</span><span class='hljl-p'>,</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>n</span><span class='hljl-p'>))</span><span class='hljl-oB'>*</span><span class='hljl-n'>dA</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>P_inv</span><span class='hljl-oB'>*</span><span class='hljl-n'>G</span><span class='hljl-p'>,</span><span class='hljl-n'>A</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>dS_l</span><span class='hljl-oB'>&#39;+</span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>P_inv</span><span class='hljl-p'>,</span><span class='hljl-n'>A</span><span class='hljl-oB'>*</span><span class='hljl-n'>S_l</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Kmn</span><span class='hljl-oB'>*</span><span class='hljl-n'>dG</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>P_inv</span><span class='hljl-p'>,</span><span class='hljl-n'>A</span><span class='hljl-oB'>*</span><span class='hljl-n'>S_l</span><span class='hljl-oB'>*</span><span class='hljl-n'>G</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>P_inv</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>dP</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
diff_K &#40;generic function with 1 method&#41;
</pre>


<p>Next, we need <span class="math">$dP_{t+1|t}$</span>:</p>
<p class="math">\[
dP_{t+1|t} = dAP_{t|t-1}A^{\prime} + AdP_{t|t-1}A^{\prime} + AP_{t|t-1}dA^{\prime} + dQ - dK_tB_tK_t^{\prime} - K_tdB_tK_t^{\prime} - K_tB_tdK_t^{\prime}
\]</p>
<p>Using vec on everything:</p>
<p class="math">\[
dvec(P_{t+1|t}) = (AP_{t|t-1} \otimes I) dvec(A) + (A \otimes A) dvec(P_{t|t-1}) + (I \otimes P_{t|t-1}A^{\prime}) dvec(A^{\prime}) + dvec(Q) - (K_tB_t \otimes I) dvec(K_t) + (K_t \otimes K_t) dvec(B_t) + (I \otimes K_tB_t) dvec(K_t^{\prime})
\]</p>
<p>We can use the commutation matrix to get:</p>
<p class="math">\[
dvec(P_{t+1|t}) = [(AP_{t|t-1} \otimes I) + (I \otimes P_{t|t-1}A^{\prime})K_{mn}] dvec(A) + (A \otimes A) dvec(P_{t|t-1}) +  + dvec(Q) - [(K_tB_t \otimes I) + (I \otimes K_tB_t)K_{mn}] dvec(K_t) + (K_t \otimes K_t) dvec(B_t)
\]</p>
<p>And the code:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>diff_S</span><span class='hljl-p'>(</span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-n'>P</span><span class='hljl-p'>,</span><span class='hljl-n'>K</span><span class='hljl-p'>,</span><span class='hljl-n'>S_l</span><span class='hljl-p'>,</span><span class='hljl-n'>dA</span><span class='hljl-p'>,</span><span class='hljl-n'>dP</span><span class='hljl-p'>,</span><span class='hljl-n'>dK</span><span class='hljl-p'>,</span><span class='hljl-n'>dS_l</span><span class='hljl-p'>,</span><span class='hljl-n'>dQ</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>m</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>P</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>Knn</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>commutation_matrix</span><span class='hljl-p'>(</span><span class='hljl-n'>n</span><span class='hljl-p'>,</span><span class='hljl-n'>n</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>Kmn</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>commutation_matrix</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>,</span><span class='hljl-n'>n</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>b1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>A</span><span class='hljl-oB'>*</span><span class='hljl-n'>S_l</span><span class='hljl-p'>,</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>n</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>n</span><span class='hljl-p'>),</span><span class='hljl-n'>A</span><span class='hljl-oB'>*</span><span class='hljl-n'>S_l</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Knn</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>dA</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'>
    </span><span class='hljl-n'>b2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>K</span><span class='hljl-oB'>*</span><span class='hljl-n'>P</span><span class='hljl-p'>,</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>n</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>n</span><span class='hljl-p'>),</span><span class='hljl-n'>K</span><span class='hljl-oB'>*</span><span class='hljl-n'>P</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Kmn</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>dK</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>transpose</span><span class='hljl-p'>(</span><span class='hljl-n'>b1</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>A</span><span class='hljl-p'>,</span><span class='hljl-n'>A</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>dS_l</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-n'>b2</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>K</span><span class='hljl-p'>,</span><span class='hljl-n'>K</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>dP</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-nf'>duplication_matrix</span><span class='hljl-p'>(</span><span class='hljl-n'>n</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>dQ</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
diff_S &#40;generic function with 1 method&#41;
</pre>


<p>Equation 2.5 is the final one we need to take the derivate:</p>
<p class="math">\[
dB_t = dGP_{t|t-1}G^{\prime} +GdP_{t|t-1}G^{\prime} + GP_{t|t-1}dG^{\prime} + dR
\]</p>
<p>Now to vec stuff:</p>
<p class="math">\[
dvec(B_t) = (GP_{t|t-1} \otimes I) dvec(G) + (G \otimes G) dvec(P_{t|t-1}) + (I \otimes GP_{t|t-1}) dvec(G^{\prime}) + dvec(R)
\]</p>
<p>Using the commutation matrix:</p>
<p class="math">\[
dvec(B_t) = [(GP_{t|t-1} \otimes I) + (I \otimes GP_{t|t-1}) K_{mn}] dvec(G) + (G \otimes G) dvec(P_{t|t-1})  + dvec(R)
\]</p>
<p>Finally, the code:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>diff_P</span><span class='hljl-p'>(</span><span class='hljl-n'>G</span><span class='hljl-p'>,</span><span class='hljl-n'>S_l</span><span class='hljl-p'>,</span><span class='hljl-n'>dG</span><span class='hljl-p'>,</span><span class='hljl-n'>dS_l</span><span class='hljl-p'>,</span><span class='hljl-n'>dR</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>m</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>G</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>G</span><span class='hljl-p'>,</span><span class='hljl-ni'>2</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>Kmn</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>commutation_matrix</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>,</span><span class='hljl-n'>n</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>b1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>G</span><span class='hljl-oB'>*</span><span class='hljl-n'>S_l</span><span class='hljl-p'>,</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-nf'>I</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>),</span><span class='hljl-n'>G</span><span class='hljl-oB'>*</span><span class='hljl-n'>S_l</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Kmn</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>dG</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>transpose</span><span class='hljl-p'>(</span><span class='hljl-n'>b1</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>kron</span><span class='hljl-p'>(</span><span class='hljl-n'>G</span><span class='hljl-p'>,</span><span class='hljl-n'>G</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>dS_l</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>dR</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
diff_P &#40;generic function with 1 method&#41;
</pre>


<h1>Log likelihood &amp; Reparametrization</h1>
<p>Let <span class="math">$f_{\theta}(\theta, y_t|Y_{t-1})$</span> be the density of <span class="math">$y_t$</span> given <span class="math">$Y_{t-1} = \{y_j\}_{j=1}^{t-1}$</span>. We will drop the subscript in <span class="math">$f$</span> when there is no ambiguity. We can write the likelihood as:</p>
<p class="math">\[
L(\theta) = \prod_{t=1}^{T} f(\theta,y_t|Y_{t-1})
\]</p>
<p>We will work with a reparametrization, which we will call <span class="math">$h:A -> \mathbb{R}^p$</span>, in which <span class="math">$p$</span> is the number of parameters. We can take <span class="math">$h_k$</span> that maps each paramater to the real line, so the jacobian matrix of the transformation will be a diagonal matrix. Let <span class="math">$J$</span> be the jacobian matrix, <span class="math">$\tilde{\theta}$</span> be the new parameters and <span class="math">$|J|$</span> the absolute value of the determinant of jacobian matrix &#40;the determinant is also called the Jacobian, which is somewhat confusing&#41;. Then, we will work with:</p>
<p class="math">\[
f_{\tilde{\theta}}(\tilde{\theta},y_t|Y_{t-1}) = f_{\theta}(h^{-1}(\tilde{\theta}),y_t|Y_{t-1})|J|
\]</p>
<p>Plugging it on the likelihood, we will have:</p>
<p class="math">\[
L(\tilde{\theta}) = \prod_{i=1}^{T} f_{\theta}(h^{-1}(\tilde{\theta}),y_t|Y_{t-1})|J|
\]</p>
<p>We want to work with the log likelihood, <span class="math">$\ell(\tilde{\theta})$</span>:</p>
<p class="math">\[
\ell(\tilde{\theta}) := \sum_{t=1}^T \left(\log(f_{\theta}(h^{-1}(\tilde{\theta}),y_t|Y_{t-1})) + \log(|J|)\right) = \\
= \sum_{t=1}^T \log(f_{\theta}(h^{-1}(\tilde{\theta}),y_t|Y_{t-1}))) + \log(|J|)
\]</p>
<p>Since we will work with <span class="math">$\log(f)$</span>, lets call it <span class="math">$\mathcal{F}$</span>:</p>
<p class="math">\[
\ell(\tilde{\theta}) = \sum_{t=1}^T \mathcal{F}(h^{-1}(\tilde{\theta}),y_t|Y_{t-1}))) + \log(|J|)
\]</p>
<p>Previously I got it wrong because I put the sample size times the Jacobian, but this clearly is wrong &#40;if <span class="math">$|J| \neq 0$</span>, then the likelihood would diverge asymptotically&#41;. When we take the derivate we will have the hard problem of dealing with the derivate of the absolute value function. There are two solutions: &#40;a&#41; ignore and let software solve and pray for the best &#40;b&#41; argue that we can use sub-gradients since <span class="math">$abs$</span> is convex. We do &#40;a&#41; knowing &#40;b&#41;. So the partial derivate is:</p>
<p class="math">\[
\frac{\partial \ell}{\partial \tilde{\theta}_j} = \sum_{t=1}^{T} \frac{\partial\mathcal{F}(h^{-1}(\tilde{\theta}))}{\partial \theta_j}\frac{\partial h^{-1}(\tilde{\theta})}{\partial \tilde{\theta}_j} + \frac{\partial \log(|J|)}{\partial \tilde{\theta}_j}
\]</p>
<p>And we now that:</p>
<p class="math">\[
\frac{\partial \log(|J|)}{\partial \tilde{\theta}_j} = \frac{\partial |J|}{\partial \tilde{\theta}_j}\frac{1}{|J|}
\]</p>
<p>And the gradient follows in the obvious manner.</p>
<p>We now combine this to have the log-posterior. Start with the posterior <span class="math">$\mathcal{P}$</span> and denote the prior by <span class="math">$P(\theta)$</span>:</p>
<p class="math">\[
\mathcal{P}(\theta|Y) = L(\theta)P(\theta)
\log(\mathcal{P}(\theta|Y)) = \ell(\theta) + \log(P(\theta))
\]</p>
<p>Notice that <span class="math">$P(\theta) = \prod_{i=1}^{p} P_i(\theta_i)$</span>. Using the reparametrization, we have, for any given i:</p>
<p class="math">\[
P_i(\tilde{\theta}) = P_i(h_i^{-1}(\tilde{\theta}_i)) \bigg\lvert\frac{dh^{-1}(\tilde{\theta}_i)}{d\tilde{\theta}_i}\bigg\lvert
\]</p>
<p>So <span class="math">$\log(P(\theta)) = \sum_{i=1}^{p} \log(P_i(\theta_i))$</span> and for the reparametrization we will have:</p>
<p class="math">\[
\log(P(\tilde{\theta})) = \sum_{i=1}^{p} \log(P_i(\tilde{\theta}_i)) + \log\left(\frac{dh_i^{-1}(\tilde{\theta}_i)}{d\tilde{\theta}_i}\right)
\]</p>
<p>So we can write the posterior as:</p>
<p class="math">\[
\log(\mathcal{P}(\tilde{\theta}|Y)) = \ell(\tilde{\theta}) + \sum_{i=1}^{p} \log(P_i(h^{-1}(\tilde{\theta}_i))) + \sum_{i=1}^{p} \log\left(\frac{dh_i^{-1}(\tilde{\theta}_i)}{d\tilde{\theta}_i}\right)
\]</p>
<p>Now lets differentiate the posterior with respect to <span class="math">$\tilde{\theta}_j$</span>. We got the derivative of the loglikelihood previously, so we are just going :</p>
<p class="math">\[
\frac{\partial \log(\mathcal{P})}{\partial \tilde{\theta}_j} = \frac{\partial \ell}{\partial \tilde{\theta}_j} + \frac{\partial P_i(\theta)}{\partial \theta_j}\frac{d h^{-1}}{d \tilde{\theta}_j} + \left(\frac{dh^{-1}}{d\tilde{\theta}_j}\right)^{-1} \frac{d abs(dh_{\tilde{\theta}_j}^{-1})}{d\tilde{\theta_j}}
\]</p>
<p>I represented the derivative of <span class="math">$h^{-1}$</span> with respect to <span class="math">$\tilde{\theta}_j$</span> using the subscript notation so it would not get to cumbersome. In Julia, thats all done in the <code>renormalization_manual.jl</code> file.</p>
<p>The functions that I used for reparametrization are &#40;those are <span class="math">$h^{-1}$</span>, since they take the whole line and reduce it to the restricted area&#41;:</p>
<ul>
<li><p>Positive parameters: exp&#40;x&#41;</p>
</li>
<li><p>Unit interval: <span class="math">$[0,1]$</span>: 1/&#40;1&#43;exp&#40;-x&#41;&#41;</p>
</li>
<li><p>Larger than 1: exp&#40;x&#41; &#43; 1</p>
</li>
</ul>
<p>The last transformation is applied to the inflation reaction parameter to guarantee that the region of non existence of equilibrium is never visited.</p>
<p>We can take the analytical derivates of the functions above. We implement it and the jacobian in Julia:</p>


<pre class='hljl'>
<span class='hljl-nf'>to_unit</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-oB'>/</span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-oB'>+</span><span class='hljl-nf'>exp</span><span class='hljl-p'>(</span><span class='hljl-oB'>-</span><span class='hljl-n'>x</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-nf'>to_positive</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>exp</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>to_one_inf</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>exp</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'>

</span><span class='hljl-nf'>d_to_unit</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>exp</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-p'>(</span><span class='hljl-nf'>exp</span><span class='hljl-p'>(</span><span class='hljl-oB'>-</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-oB'>+</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-oB'>^</span><span class='hljl-ni'>2</span><span class='hljl-t'>
</span><span class='hljl-nf'>d_to_positive</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>exp</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>d_to_one_inf</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>exp</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>renormalization</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-n'>J_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>d_to_unit</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>J_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>d_to_positive</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>J_3</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>d_to_unit</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>4</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>J_4</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>d_to_positive</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>5</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>J_5</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>d_to_positive</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>6</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>J_6</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>d_to_positive</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>7</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>J_7</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>d_to_one_inf</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>8</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>J_8</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>d_to_positive</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>9</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>J_9</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>d_to_unit</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>10</span><span class='hljl-p'>])</span><span class='hljl-t'>

    </span><span class='hljl-k'>return</span><span class='hljl-p'>([</span><span class='hljl-n'>J_1</span><span class='hljl-p'>;</span><span class='hljl-n'>J_2</span><span class='hljl-p'>;</span><span class='hljl-n'>J_3</span><span class='hljl-p'>;</span><span class='hljl-n'>J_4</span><span class='hljl-p'>;</span><span class='hljl-n'>J_5</span><span class='hljl-p'>;</span><span class='hljl-n'>J_6</span><span class='hljl-p'>;</span><span class='hljl-n'>J_7</span><span class='hljl-p'>;</span><span class='hljl-n'>J_8</span><span class='hljl-p'>;</span><span class='hljl-n'>J_9</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
renormalization &#40;generic function with 1 method&#41;
</pre>


<p>In which the parameter vector is <span class="math">$\left[\beta,\epsilon,\theta,\sigma,\sigma_u^2,\phi,\phi_{\pi},\phi_y,\rho_v\right]$</span></p>
<p>And now the function that takes the parameters defined in <span class="math">$\mathbb{R}^p$</span> and convert them to the loglikelihood and apply the correction of the Jacobian and the derivate of the jacobian to the loglikelihood and to the gradient, respectively:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>dens_and_grad</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>,</span><span class='hljl-n'>data</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>alfa</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>bet</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>to_unit</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>epsilon</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>to_positive</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>theta</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>to_unit</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>4</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>sig</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>to_positive</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>5</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>s2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>to_positive</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>6</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>phi</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>to_positive</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>7</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>phi_pi</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>to_one_inf</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>8</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>phi_y</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>to_positive</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>9</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>rho_v</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>to_unit</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>[</span><span class='hljl-ni'>10</span><span class='hljl-p'>])</span><span class='hljl-t'>

    </span><span class='hljl-n'>renorm</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>renormalization</span><span class='hljl-p'>(</span><span class='hljl-n'>par</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>jacob</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>abs</span><span class='hljl-p'>(</span><span class='hljl-nf'>prod</span><span class='hljl-p'>(</span><span class='hljl-n'>renorm</span><span class='hljl-p'>))</span><span class='hljl-t'>

    </span><span class='hljl-n'>renorm_diff</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>gradient</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-oB'>-&gt;</span><span class='hljl-nf'>abs</span><span class='hljl-p'>(</span><span class='hljl-nf'>prod</span><span class='hljl-p'>(</span><span class='hljl-nf'>renormalization</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>))),</span><span class='hljl-n'>par</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-cs'>#derivate of abs det of Jacobian matrix</span><span class='hljl-t'>

    </span><span class='hljl-n'>diff_correction</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-oB'>/</span><span class='hljl-n'>jacob</span><span class='hljl-oB'>*</span><span class='hljl-n'>renorm_diff</span><span class='hljl-t'>
    </span><span class='hljl-n'>diff_correction</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>diff_correction</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-oB'>:</span><span class='hljl-ni'>10</span><span class='hljl-p'>]</span><span class='hljl-t'>

    </span><span class='hljl-nf'>log_p_bet</span><span class='hljl-p'>(</span><span class='hljl-n'>bet</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>logpdf</span><span class='hljl-p'>(</span><span class='hljl-n'>prior_bet</span><span class='hljl-p'>,</span><span class='hljl-n'>bet</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>log_p_epsilon</span><span class='hljl-p'>(</span><span class='hljl-n'>epsilon</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>logpdf</span><span class='hljl-p'>(</span><span class='hljl-n'>prior_epsilon</span><span class='hljl-p'>,</span><span class='hljl-n'>epsilon</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>log_p_theta</span><span class='hljl-p'>(</span><span class='hljl-n'>theta</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>logpdf</span><span class='hljl-p'>(</span><span class='hljl-n'>prior_theta</span><span class='hljl-p'>,</span><span class='hljl-n'>theta</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>log_p_sig</span><span class='hljl-p'>(</span><span class='hljl-n'>sig</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>logpdf</span><span class='hljl-p'>(</span><span class='hljl-n'>prior_sig</span><span class='hljl-p'>,</span><span class='hljl-n'>sig</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>log_p_s2</span><span class='hljl-p'>(</span><span class='hljl-n'>s2</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>logpdf</span><span class='hljl-p'>(</span><span class='hljl-n'>prior_s2</span><span class='hljl-p'>,</span><span class='hljl-n'>s2</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>log_p_phi</span><span class='hljl-p'>(</span><span class='hljl-n'>phi</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>logpdf</span><span class='hljl-p'>(</span><span class='hljl-n'>prior_phi</span><span class='hljl-p'>,</span><span class='hljl-n'>phi</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>log_p_phi_pi</span><span class='hljl-p'>(</span><span class='hljl-n'>phi_pi</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>logpdf</span><span class='hljl-p'>(</span><span class='hljl-n'>prior_phi_pi</span><span class='hljl-p'>,</span><span class='hljl-n'>phi_pi</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>log_p_phi_y</span><span class='hljl-p'>(</span><span class='hljl-n'>phi_y</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>logpdf</span><span class='hljl-p'>(</span><span class='hljl-n'>prior_phi_y</span><span class='hljl-p'>,</span><span class='hljl-n'>phi_y</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>log_p_rho_v</span><span class='hljl-p'>(</span><span class='hljl-n'>rho_v</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>logpdf</span><span class='hljl-p'>(</span><span class='hljl-n'>prior_rho_v</span><span class='hljl-p'>,</span><span class='hljl-n'>rho_v</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-n'>llh</span><span class='hljl-p'>,</span><span class='hljl-n'>dll</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>log_like_dsge</span><span class='hljl-p'>([</span><span class='hljl-n'>alfa</span><span class='hljl-p'>,</span><span class='hljl-n'>bet</span><span class='hljl-p'>,</span><span class='hljl-n'>epsilon</span><span class='hljl-p'>,</span><span class='hljl-n'>theta</span><span class='hljl-p'>,</span><span class='hljl-n'>sig</span><span class='hljl-p'>,</span><span class='hljl-n'>s2</span><span class='hljl-p'>,</span><span class='hljl-n'>phi</span><span class='hljl-p'>,</span><span class='hljl-n'>phi_pi</span><span class='hljl-p'>,</span><span class='hljl-n'>phi_y</span><span class='hljl-p'>,</span><span class='hljl-n'>rho_v</span><span class='hljl-p'>],</span><span class='hljl-n'>data</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>llh</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>llh</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>data</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-nf'>log</span><span class='hljl-p'>(</span><span class='hljl-n'>jacob</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>log_p_bet</span><span class='hljl-p'>(</span><span class='hljl-n'>bet</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>log_p_epsilon</span><span class='hljl-p'>(</span><span class='hljl-n'>epsilon</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>log_p_theta</span><span class='hljl-p'>(</span><span class='hljl-n'>theta</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>log_p_sig</span><span class='hljl-p'>(</span><span class='hljl-n'>sig</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>log_p_s2</span><span class='hljl-p'>(</span><span class='hljl-n'>s2</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>log_p_phi</span><span class='hljl-p'>(</span><span class='hljl-n'>phi</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>log_p_phi_pi</span><span class='hljl-p'>(</span><span class='hljl-n'>phi_pi</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>log_p_phi_y</span><span class='hljl-p'>(</span><span class='hljl-n'>phi_y</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>log_p_rho_v</span><span class='hljl-p'>(</span><span class='hljl-n'>rho_v</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>sum</span><span class='hljl-p'>(</span><span class='hljl-n'>log</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-n'>abs</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-n'>renorm</span><span class='hljl-p'>)))</span><span class='hljl-t'>
    </span><span class='hljl-n'>dll</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>dll</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-oB'>:</span><span class='hljl-ni'>10</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>dll</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>dll</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-n'>renorm</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>data</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>diff_correction</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>derivative</span><span class='hljl-p'>(</span><span class='hljl-n'>log_p_bet</span><span class='hljl-p'>,</span><span class='hljl-n'>bet</span><span class='hljl-p'>);</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>derivative</span><span class='hljl-p'>(</span><span class='hljl-n'>log_p_epsilon</span><span class='hljl-p'>,</span><span class='hljl-n'>epsilon</span><span class='hljl-p'>);</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>derivative</span><span class='hljl-p'>(</span><span class='hljl-n'>log_p_theta</span><span class='hljl-p'>,</span><span class='hljl-n'>theta</span><span class='hljl-p'>);</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>derivative</span><span class='hljl-p'>(</span><span class='hljl-n'>log_p_sig</span><span class='hljl-p'>,</span><span class='hljl-n'>sig</span><span class='hljl-p'>);</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>derivative</span><span class='hljl-p'>(</span><span class='hljl-n'>log_p_s2</span><span class='hljl-p'>,</span><span class='hljl-n'>s2</span><span class='hljl-p'>);</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>derivative</span><span class='hljl-p'>(</span><span class='hljl-n'>log_p_phi</span><span class='hljl-p'>,</span><span class='hljl-n'>phi</span><span class='hljl-p'>);</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>derivative</span><span class='hljl-p'>(</span><span class='hljl-n'>log_p_phi_pi</span><span class='hljl-p'>,</span><span class='hljl-n'>phi_pi</span><span class='hljl-p'>);</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>derivative</span><span class='hljl-p'>(</span><span class='hljl-n'>log_p_phi_y</span><span class='hljl-p'>,</span><span class='hljl-n'>phi_y</span><span class='hljl-p'>);</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>derivative</span><span class='hljl-p'>(</span><span class='hljl-n'>log_p_rho_v</span><span class='hljl-p'>,</span><span class='hljl-n'>rho_v</span><span class='hljl-p'>);]</span><span class='hljl-t'>

    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>llh</span><span class='hljl-p'>,</span><span class='hljl-n'>dll</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
dens_and_grad &#40;generic function with 1 method&#41;
</pre>



        <HR/>
        <div class="footer">
          <p>
            Published from <a href="hmc_take_two.jmd">hmc_take_two.jmd</a>
            using <a href="http://github.com/JunoLab/Weave.jl">Weave.jl</a> v0.10.3 on 2020-09-15.
          </p>
        </div>
      </div>
    </div>
  </div>
</BODY>

</HTML>
